<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FoodDelivery System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container">
        <a class="navbar-brand" href="/">
            <i class="fas fa-utensils me-2"></i>FoodDelivery
        </a>
        <div class="navbar-nav">
            <a class="nav-link active" th:href="@{http://localhost:8084/}">Главная</a>
            <a class="nav-link" href="/">Заказы</a>
<!--            <a href="/assigned-orders">Просмотреть назначенные заказы</a>-->
            <!--            <a class="nav-link" href="/">Статистика</a>-->
        </div>
    </div>
</nav>

<div class="container mt-4">
    <!-- Уведомления -->
    <div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show" role="alert">
        <span th:text="${successMessage}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show" role="alert">
        <span th:text="${errorMessage}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>


    <div class="hero-section text-center rounded p-5 mb-4">
        <h1 class="display-4 fw-bold">Система доставки еды</h1>
        <p class="lead">Управление курьерами и заказами</p>
    </div>

    <div class="row mb-4">
        <div class="col-md-3 mb-3">
            <div class="card stat-card bg-primary text-white">
                <div class="card-body text-center">
                    <h5 class="card-title">Всего курьеров</h5>
                    <h2 th:text="${couriers.size()}" class="card-text">0</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card stat-card bg-success text-white">
                <div class="card-body text-center">
                    <h5 class="card-title">Доступные</h5>
                    <h2 th:text="${availableCount}" class="card-text">0</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card stat-card bg-warning text-dark">
                <div class="card-body text-center">
                    <h5 class="card-title">Занятые</h5>
                    <h2 th:text="${busyCount}" class="card-text">0</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card stat-card bg-info text-white">
                <div class="card-body text-center">
                    <h5 class="card-title">Активные заказы</h5>
                    <h2 th:text="${totalOrders}" class="card-text">0</h2>
                </div>
            </div>
        </div>
    </div>

    <div class="card shadow mb-4">
        <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
            <h4 class="mb-0"><i class="fas fa-motorcycle me-2"></i>Управление курьерами</h4>
            <div>
                <button type="button" class="btn btn-primary" id="locationButton" data-bs-toggle="modal" data-bs-target="#locationModal">
                    Локации
                </button>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#courierModal">
                    <i class="fas fa-plus me-1"></i>Добавить курьера
                </button>
            </div>
        </div>


        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-dark">
                    <tr>
                        <th>ID</th>
                        <th>Имя</th>
                        <th>Телефон</th>
                        <th>Email</th>
                        <th>Локация</th>
                        <th>Активные заказы</th>
                        <th>Вместимость</th>
                        <th>Статус</th>
                        <th>Действия</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="courier : ${couriers}" th:if="${courier != null}">
                        <td th:text="${courier.id}"></td>
                        <td th:text="${courier.name}"></td>
                        <td th:text="${courier.phone}"></td>
                        <td th:text="${courier.email}"></td>
                        <td th:text="${courier.currentLocation != null ? courier.currentLocation : 'Не задана'}"></td>
                        <td th:text="${courier.activeOrders != null ? courier.activeOrders : 0}"></td>
                        <td th:text="${courier.maxCapacity != null ? courier.maxCapacity : 3}"></td>
                        <td th:text="${courier.isAvailable != null ? courier.isAvailable ? 'Доступен' : 'Занят' : 'Неизвестно'}"
                            th:classappend="${courier.isAvailable} ? 'status-available' : 'status-busy'">
                        </td>
                        <td class="courier-actions">
                            <div class="d-flex gap-2">
                                <form th:action="@{/couriers/{id}/assign-order(id=${courier.id})}" method="post">
                                    <button type="submit" class="btn btn-sm btn-primary"
                                            th:disabled="${!courier.isAvailable or (courier.activeOrders != null and courier.maxCapacity != null and courier.activeOrders >= courier.maxCapacity)}">Заказ</button>
                                </form>
                                <form th:action="@{/couriers/{id}/complete-order(id=${courier.id})}" method="post">
                                    <button type="submit" class="btn btn-sm btn-success">Завершить</button>
                                </form>
                                <form th:action="@{/couriers/{id}/delete(id=${courier.id})}" method="post">
                                    <button type="submit" class="btn btn-sm btn-danger">Удалить</button>
                                </form>
                                <button type="button" class="btn btn-sm btn-warning edit-courier"
                                        th:attr="data-id=${courier.id}, data-name=${courier.name}, data-phone=${courier.phone}, data-email=${courier.email}, data-location-id=${courier.currentLocation != null ? courier.currentLocation.id : ''}, data-max-capacity=${courier.maxCapacity}, data-is-available=${courier.isAvailable}">Изменить</button>
                            </div>
                        </td>
                    <tr th:if="${#lists.isEmpty(couriers) or couriers == null}">
                        <td colspan="9" class="text-center">Курьеры отсутствуют</td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно редактирования курьера -->
<div class="modal fade" id="editCourierModal" tabindex="-1" aria-labelledby="editCourierModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editCourierModalLabel">Редактировать курьера</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editCourierForm" th:action="@{/couriers/__id__}" method="post" th:object="${newCourier}">
                    <input type="hidden" th:field="*{id}" id="editCourierId" />
                    <div class="mb-3">
                        <label for="editName" class="form-label">Имя курьера</label>
                        <input type="text" th:field="*{name}" id="editName" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label for="editPhone" class="form-label">Телефон</label>
                        <input type="text" th:field="*{phone}" id="editPhone" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label for="editEmail" class="form-label">Email</label>
                        <input type="text" th:field="*{email}" id="editEmail" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label for="editCurrentLocationId" class="form-label">Локация</label>
                        <select th:field="*{currentLocation.id}" id="editCurrentLocationId" class="form-control form-select" required>
                            <option value="">Выберите локацию</option>
                            <option th:each="loc : ${locations}" th:value="${loc.id}" th:text="${loc}"></option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="editMaxCapacity" class="form-label">Макс. вместимость</label>
                        <input type="number" th:field="*{maxCapacity}" id="editMaxCapacity" class="form-control" min="1" required>
                    </div>
                    <div class="mb-3">
                        <label for="editIsAvailable" class="form-label">Статус</label>
                        <select th:field="*{isAvailable}" id="editIsAvailable" class="form-control form-select" required>
                            <option value="true">Доступен</option>
                            <option value="false">Занят</option>
                        </select>
                    </div>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="submit" class="btn btn-primary">Сохранить</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно добавления курьера -->
<div class="modal fade" id="courierModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Добавить курьера</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form th:action="@{/couriers}" method="post">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="courierName" class="form-label">Имя курьера</label>
                        <input type="text" class="form-control" id="courierName" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label for="courierPhone" class="form-label">Телефон</label>
                        <input type="tel" class="form-control" id="courierPhone" name="phone" required>
                    </div>
                    <div class="mb-3">
                        <label for="courierEmail" class="form-label">Email</label>
                        <input type="email" class="form-control" id="courierEmail" name="email" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Локация</label>
                        <select name="currentLocation.id" class="form-control form-select" required>
                            <option value="">Выберите локацию</option>
                            <option th:each="loc : ${locations}" th:value="${loc.id}" th:text="${loc}"></option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="courierCapacity" class="form-label">Макс. вместимость</label>
                        <input type="number" class="form-control" id="courierCapacity" name="maxCapacity" value="3" min="1" max="10">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="submit" class="btn btn-primary">Сохранить</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Модальное окно обновления локаций -->
<div class="modal fade" id="locationModal" tabindex="-1" aria-labelledby="locationModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="locationModalLabel">Управление локациями</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <table class="table">
                    <thead>
                    <tr>
                        <th>ID</th>
                        <th>Район</th>
                        <th>Улица</th>
                        <th>Дом</th>
                        <th>Действия</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="location : ${locations}" th:if="${location != null}">
                        <td th:text="${location.id}"></td>
                        <td th:text="${location.district}"></td>
                        <td th:text="${location.street}"></td>
                        <td th:text="${location.house}"></td>
                        <td>
                            <button type="button" class="btn btn-sm btn-warning edit-location"
                                    th:attr="data-id=${location.id}, data-district=${location.district}, data-street=${location.street}, data-house=${location.house}">Изменить</button>
                            <form th:action="@{/locations/{id}/delete(id=${location.id})}" method="post" style="display:inline;">
                                <button type="submit" class="btn btn-sm btn-danger">Удалить</button>
                            </form>
                        </td>
                    </tr>
                    <tr th:if="${#lists.isEmpty(locations) or locations == null}">
                        <td colspan="5" class="text-center">Локации отсутствуют</td>
                    </tr>
                    </tbody>
                </table>
                <div id="locationForm" style="display:none;">
                    <form th:action="@{/locations}" method="post" th:object="${newLocation}">
                        <input type="hidden" th:field="*{id}" id="locationId" />
                        <div class="mb-3">
                            <label for="district" class="form-label">Район</label>
                            <input type="text" th:field="*{district}" id="district" class="form-control" required />
                        </div>
                        <div class="mb-3">
                            <label for="street" class="form-label">Улица</label>
                            <input type="text" th:field="*{street}" id="street" class="form-control" required />
                        </div>
                        <div class="mb-3">
                            <label for="house" class="form-label">Дом</label>
                            <input type="text" th:field="*{house}" id="house" class="form-control" required />
                        </div>

                        <button type="submit" class="btn btn-primary" id="saveLocation">Сохранить</button>
                        <button type="button" class="btn btn-secondary" id="cancelLocation">Отмена</button>
                    </form>
                </div>
                <button type="button" class="btn btn-success add-location">Добавить локацию</button>
                <th:block th:if="${errorMessage}">
                    <div class="alert alert-danger" role="alert">
                        [[${errorMessage}]]
                    </div>
                </th:block>
            </div>
        </div>
    </div>
</div>

<div th:if="${assignedOrders}">
    <h2>Назначенные заказы курьерам</h2>
    <table>
        <thead>
        <tr>
            <th>Курьер ID</th>
            <th>Заказ ID</th>
            <th>Адрес заказа (код)</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="assign : ${assignedOrders}">
            <td th:text="${assign.courierId}"></td>
            <td th:text="${assign.orderId}"></td>
            <td th:text="${assign.orderAddressCode}"></td>
        </tr>
        </tbody>
    </table>
</div>

<script th:inline="javascript">
    document.addEventListener('DOMContentLoaded', function() {
        const locationModalElement = document.getElementById('locationModal');
        if (!locationModalElement) {
            console.error('Modal element with ID "locationModal" not found');
            return;
        }
        const locationModal = new bootstrap.Modal(document.getElementById('locationModal'));
        const editCourierModal = new bootstrap.Modal(document.getElementById('editCourierModal'));
        const locationForm = document.getElementById('locationForm');
        const addLocationBtn = document.querySelector('.add-location');
        const editButtons = document.querySelectorAll('.edit-location');
        const saveLocationBtn = document.getElementById('saveLocation');
        const cancelLocationBtn = document.getElementById('cancelLocation');
        const form = document.querySelector('#locationForm form');
        const editCourierButtons = document.querySelectorAll('.edit-courier');
        const editCourierForm = document.getElementById('editCourierForm');

        if (!locationForm || !addLocationBtn || !saveLocationBtn || !cancelLocationBtn || !form) {
            console.error('One or more required elements not found');
            return;
        }

        // Кнопка открытия модала
        document.querySelector('#locationButton').addEventListener('click', function() {
            locationModal.show();
        });

        addLocationBtn.addEventListener('click', function() {
            locationForm.style.display = 'block';
            document.getElementById('locationId').value = '';
            document.getElementById('district').value = '';
            document.getElementById('street').value = '';
            document.getElementById('house').value = '';
            form.setAttribute('action', '/locations');
            form.setAttribute('method', 'post');
        });

        editButtons.forEach(button => {
            button.addEventListener('click', function() {
                locationForm.style.display = 'block';
                const id = this.getAttribute('data-id');
                document.getElementById('locationId').value = id;
                document.getElementById('district').value = this.getAttribute('data-district');
                document.getElementById('street').value = this.getAttribute('data-street');
                document.getElementById('house').value = this.getAttribute('data-house');
                form.setAttribute('action', '/locations/' + id + '/update');
                form.setAttribute('method', 'post');
            });
        });

        cancelLocationBtn.addEventListener('click', function() {
            locationForm.style.display = 'none';
        });

        editCourierButtons.forEach(button => {
            button.addEventListener('click', function() {
                const id = this.getAttribute('data-id');
                document.getElementById('editCourierId').value = id;
                document.getElementById('editName').value = this.getAttribute('data-name');
                document.getElementById('editPhone').value = this.getAttribute('data-phone');
                document.getElementById('editEmail').value = this.getAttribute('data-email');
                document.getElementById('editCurrentLocationId').value = this.getAttribute('data-location-id');
                document.getElementById('editMaxCapacity').value = this.getAttribute('data-max-capacity');
                document.getElementById('editIsAvailable').value = this.getAttribute('data-is-available') === 'true';
                editCourierForm.setAttribute('action', '/couriers/' + id);
                editCourierModal.show();
            });
        });
    });


</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>